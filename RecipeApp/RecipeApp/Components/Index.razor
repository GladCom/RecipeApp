@page "/"
@rendermode InteractiveServer
@using RecipeApp.Model
@inject RecipesDbContext DbContext
@inject NavigationManager NavigationManager
@inject IJSRuntime Js

<main>
    <h1 class="text-center">Рецепты</h1>
    <div class="search-and-add">
        <div class="search-container">
            <input type="text" class="form-control search-box" placeholder="Найти блюдо..." @bind="SearchText" />
        </div>
        <button class="btn btn-primary add-button mt-2" @onclick="AddRecipe">Добавить блюдо</button>
    </div>

@if (recipes == null)
{
    <p>Загрузка...</p>
}
else if (!recipes.Any())
{
    <p>Рецептов пока нет.</p>
}
else
{
    <div class="recipe-list">
        @foreach (var recipe in PagedRecipes)
        {
            <div class="recipe-item border-bottom pb-3 mb-3">
                <div class="recipe-title" @onclick="() => ViewRecipe(recipe.Id)">
                    @recipe.Title
                </div>

                @if (recipe.Ingredients.Any())
                {
                    <div class="recipe-ingredients mt-1">
                        @string.Join(", ", recipe.Ingredients.Select(i => i.Name.ToLower()))
                    </div>
                }
            </div>
        }
    </div>

    @if (TotalPages > 1)
    {
        <nav>
            <ul class="pagination">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => GoToPage(currentPage - 1)">«</button>
                </li>
                @for (int i = 1; i <= TotalPages; i++)
                {
                    var pageNumber = i; // Локальная переменная для замыкания
                    <li class="page-item @(pageNumber == currentPage ? "active" : "")">
                        <button class="page-link" @onclick="() => GoToPage(pageNumber)">@pageNumber</button>
                    </li>
                }
                <li class="page-item @(currentPage == TotalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => GoToPage(currentPage + 1)">»</button>
                </li>
            </ul>
        </nav>
    }

}
</main>
@code {
    private List<Recipe>? recipes;

    protected override async Task OnInitializedAsync()
    {
        recipes = await DbContext.Recipes
            .Include(r => r.Ingredients)
            .ToListAsync();
    }

    void AddRecipe()
    {
        NavigationManager.NavigateTo("/recipes/new");
    }

    void ViewRecipe(int id)
    {
        NavigationManager.NavigateTo($"/recipes/{id}");
    }

    private string _searchText = "";

    private string SearchText
    {
        get => _searchText;
        set
        {
            if (_searchText != value)
            {
                _searchText = value;
                currentPage = 1;
            }
        }
    }

    private IEnumerable<Recipe> FilteredRecipes
    {
        get
        {
            return string.IsNullOrWhiteSpace(_searchText)
                ? recipes!
                : recipes!.Where(r =>
                    r.Title.Contains(_searchText, StringComparison.OrdinalIgnoreCase));
        }
    }

    private int currentPage = 1;
    private const int pageSize = 10;

    private int TotalPages => (int)Math.Ceiling((double)(FilteredRecipes?.Count() ?? 0) / pageSize);

    private IEnumerable<Recipe> PagedRecipes =>
        FilteredRecipes?
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
        ?? [];

    void GoToPage(int page)
    {
        if (page >= 1 && page <= TotalPages)
        {
            currentPage = page;
        }
    }
}